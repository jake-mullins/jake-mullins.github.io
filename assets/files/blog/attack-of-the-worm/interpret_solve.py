#!/usr/local/bin/python
import sys
from math import floor
import numpy as np
from PIL import Image
import torch
import torch.nn as nn
from torchvision.models import resnet18
from random import randint

model = resnet18()
model.fc = nn.Linear(model.fc.in_features, 1)
model.load_state_dict(torch.load("model.pt"))

original = np.array(Image.open("worm.png"))

def score(mods):
    modified = original.copy()
    mods = unflatten(mods)
    for mod in mods:
        x = floor(mod[0] * 224)
        y = floor(mod[1] * 224)
        r = floor(mod[2] * 256)
        g = floor(mod[3] * 256)
        b = floor(mod[4] * 256)
        modified[y, x] = [r, g, b]

    x = torch.tensor(
        modified.transpose(2, 0, 1) / 255.0, dtype=torch.float32
    ).unsqueeze(0)
    with torch.no_grad():
        y = torch.sigmoid(model(x))
    return y


def unflatten(flat_mods: list):
    assert len(flat_mods) % 5 == 0
    mods = []
    for i in range(len(flat_mods) // 5):
        mod = [
            flat_mods[(i * 5) + 0],
            flat_mods[(i * 5) + 1],
            flat_mods[(i * 5) + 2],
            flat_mods[(i * 5) + 3],
            flat_mods[(i * 5) + 4],
        ]
        mods.append(mod)
    return mods

inputs = [
    0.6205357142857143,
    0.6964285714285714,
    0.5390625,
    0.6875,
    0.30078125,
    0.5535714285714286,
    0.5535714285714286,
    0.86328125,
    0.66796875,
    0.87890625,
    0.8883928571428571,
    0.8080357142857143,
    0.94140625,
    0.9609375,
    0.12109375,
    0.8526785714285714,
    0.5089285714285714,
    0.87109375,
    0.28515625,
    0.3828125,
    0.8526785714285714,
    0.9017857142857143,
    0.8515625,
    0.91796875,
    0.01171875,
    0.38392857142857145,
    0.49107142857142855,
    0.7578125,
    0.2890625,
    0.58984375,
    0.9642857142857143,
    0.6607142857142857,
    0.125,
    0.9609375,
    0.41796875,
    0.9598214285714286,
    0.8258928571428571,
    0.2265625,
    0.96484375,
    0.50390625,
    0.41964285714285715,
    0.59375,
    0.38671875,
    0.921875,
    0.76171875,
    0.7410714285714286,
    0.044642857142857144,
    0.72265625,
    0.88671875,
    0.71484375,
    0.7589285714285714,
    0.14732142857142858,
    0.03125,
    0.73046875,
    0.97265625,
    0.36607142857142855,
    0.03571428571428571,
    0.74609375,
    0.2109375,
    0.0625,
    0.16517857142857142,
    0.0625,
    0.4765625,
    0.99609375,
    0.78125,
    0.4330357142857143,
    0.59375,
    0.921875,
    0.625,
    0.4921875,
    0.6116071428571429,
    0.9375,
    0.6875,
    0.25390625,
    0.8046875,
    0.03571428571428571,
    0.8928571428571429,
    0.9375,
    0.796875,
    0.9765625,
    0.7008928571428571,
    0.84375,
    0.51171875,
    0.89453125,
    0.72265625,
    0.6607142857142857,
    0.5178571428571429,
    0.98046875,
    0.90625,
    0.83984375,
    0.15625,
    0.9419642857142857,
    0.921875,
    0.92578125,
    0.875,
    0.9598214285714286,
    0.6919642857142857,
    0.9375,
    0.6328125,
    0.71875,
    0.39285714285714285,
    0.47767857142857145,
    0.57421875,
    0.734375,
    0.046875,
    0.9910714285714286,
    0.3080357142857143,
    0.3984375,
    0.01953125,
    0.93359375,
    0.65625,
    0.65625,
    0.1953125,
    0.82421875,
    0.87109375,
    0.8258928571428571,
    0.125,
    0.76171875,
    0.73046875,
    0.890625,
    0.8080357142857143,
    0.5223214285714286,
    0.2734375,
    0.02734375,
    0.296875,
    0.6428571428571429,
    0.16071428571428573,
    0.21875,
    0.90625,
    0.01171875,
    0.5535714285714286,
    0.36607142857142855,
    0.109375,
    0.4453125,
    0.2265625,
    0.2857142857142857,
    0.27232142857142855,
    0.20703125,
    0.97265625,
    0.84765625,
    0.8258928571428571,
    0.008928571428571428,
    0.890625,
    0.5703125,
    0.15625,
    0.8125,
    0.12946428571428573,
    0.26171875,
    0.84375,
    0.8671875,
]

mods = unflatten(inputs)
print(mods)
num_of_pixels = 30

for i in range(num_of_pixels):
    mods[i][0] = str(round(mods[i][0] * 224))
    mods[i][1] = str(round(mods[i][1] * 224))

    mods[i][2] = str(round(mods[i][2] * 256))
    mods[i][3] = str(round(mods[i][3] * 256))
    mods[i][4] = str(round(mods[i][4] * 256))

print(score(inputs))

res = ""
for pixel in mods:
    res += ",".join(pixel)
    res += ";"

print(res)
